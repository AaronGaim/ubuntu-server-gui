<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">// Generated by CoffeeScript 1.3.3

define(['jquery', 'underscore', 'backbone', 'backbone_marionette', 'router', 'controller/Main', 'model/Session', 'model/User'], function($, _, Backbone, BackboneMarionette, Router, MainController, Session, User) {
  var App;
  App = new BackboneMarionette.Application();
<span id='global-property-'>  /**
</span>   * Sets up main application regions for toolbar
   * and viewport.
   *
   * Bound to initialize:before to make sure
   * the regions are always avaialable before
   * anything else runs.
   *
  */

  App.bind('initialize:before', function(options) {
    App.addRegions({
      mainToolbar: &quot;#main_toolbar_container&quot;,
      mainViewport: &quot;#viewport&quot;
    });
  });
<span id='global-property-'>  /**
</span>   * Sets up User and Session model objects
   * and attaches them to the application instance.
   * 
   * Creates a MainController instance and corresponding
   * Backbone Router object.
   * 
   * Kickstarts the app via Backbone.history.start.
   *
   * Bound to initialize:after to make sure
   * all initializers have run before starting the app.
   *
  */

  App.bind('initialize:after', function(options) {
    var mainController;
    this.routers = {};
    this.user = new User();
    this.user.session = new Session({
      app: this
    });
    this.user.session.on('change:active', function(model, active) {
      var toolbar;
      if (active === true) {
        toolbar = new MainToolbar();
        this.mainToolbar.show(toolbar);
      }
    });
    mainController = new MainController({
      app: this
    });
    this.routers.main = new Router({
      controller: mainController
    });
    Backbone.history.start({
      pushState: false
    });
  });
<span id='global-property-'>  /**
</span>   * Overrides for BackboneMarionette templating loading
   * and rendering. Optimizing Marionette for using underscore
   * templates along with Require.js.
   *
   * https://github.com/derickbailey/backbone.marionette/wiki/Using-marionette-with-requirejs
   *
  */

  App.addInitializer(function(options) {
    Backbone.Marionette.TemplateCache.prototype.loadTemplate = function(templateId) {
      var err, msg, template;
      template = templateId;
      if (!template || template.length === 0) {
        msg = &quot;Could not find template: '&quot; + templateId + &quot;'&quot;;
        err = new Error(msg);
        err.name = &quot;NoTemplateError&quot;;
        throw err;
      }
      return template;
    };
    BackboneMarionette.Renderer.render = function(template, data) {
      return template(data);
    };
  });
<span id='global-property-'>  /**
</span>   * Overrides Backbone.wrapError to trigger an Application
   * server:error event whenenver an ajax call returns a
   * 401 status code.
   *
   * Allows us to centeralize the way the app responds to
   * session timeouts and un-authenticated user condition.
   *
  */

  App.addInitializer(function(options) {
    var _this = this;
    App.onServerError = function(originalModel, jqXHR, options) {
      if (jqXHR.status === 401) {
        _this.user.session.set('active', false);
      }
    };
    App.vent.bind(&quot;server:error&quot;, App.onServerError);
    Backbone.wrapError = function(onError, originalModel, options) {
      return function(model, resp) {
        if (model === originalModel) {
          resp = resp;
        } else {
          resp = model;
        }
        if (onError) {
          onError(originalModel, resp, options);
        } else {
          originalModel.trigger('error', originalModel, resp, options);
          App.vent.trigger('server:error', originalModel, resp, options);
        }
      };
    };
  });
<span id='global-property-'>  /**
</span>   * Sets up some application wide data formatting
   * utilities.
   * 
   * TODO: put these in their own class/module.
  */

  App.addInitializer(function(options) {
    this.formatters = {};
    this.formatters.formatBytes = function(size) {
      if (size &lt; 1024) {
        return size + &quot;kb&quot;;
      } else if (size &lt; 1048576) {
        return (Math.round(((size * 10) / 1024) / 10)) + &quot;KB&quot;;
      } else {
        return (Math.round(((size * 10) / 1048576) / 10)) + &quot;MB&quot;;
      }
    };
    this.formatters.toTitleCase = function(str) {
      return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1);
      });
    };
  });
  return App;
});
</pre>
</body>
</html>
