<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">define([
    'jquery'
    'underscore'
    'backbone'
    'backbone_marionette'
    'router'
    'controller/Main'
    'model/Session'
    'model/User'
],
($, _, Backbone, BackboneMarionette, Router, MainController, Session, User) -&gt;

    App = new BackboneMarionette.Application()

    ###*
     * Sets up main application regions for toolbar
     * and viewport.
     *
     * Bound to initialize:before to make sure
     * the regions are always avaialable before
     * anything else runs.
     *
     ###
    App.bind('initialize:before', (options) -&gt;
        App.addRegions({
            mainToolbar: &quot;#main_toolbar_container&quot;
            mainViewport: &quot;#viewport&quot;
        })
        return
    )

    ###*
     * Sets up User and Session model objects
     * and attaches them to the application instance.
     * 
     * Creates a MainController instance and corresponding
     * Backbone Router object.
     * 
     * Kickstarts the app via Backbone.history.start.
     *
     * Bound to initialize:after to make sure
     * all initializers have run before starting the app.
     *
     ###
    App.bind('initialize:after', (options) -&gt;
        @routers = {} # setup a place to store routers

        @user = new User()
        @user.session = new Session({app: @})

        @user.session.on('change:active', (model, active) -&gt;
            if(active == true)
                toolbar = new MainToolbar()    # only show main toolbar is user is logged in
                @mainToolbar.show(toolbar)

            return
        )        

        mainController = new MainController({app: @})
        
        @routers.main = new Router({controller: mainController})
        Backbone.history.start({pushState: false})
        return
    )
    
    ###*
     * Overrides for BackboneMarionette templating loading
     * and rendering. Optimizing Marionette for using underscore
     * templates along with Require.js.
     *
     * https://github.com/derickbailey/backbone.marionette/wiki/Using-marionette-with-requirejs
     *
     ###
    App.addInitializer((options) -&gt;
        # See &quot;Using marionette with requirejs&quot; in Marionette's Github Repo for details
        Backbone.Marionette.TemplateCache.prototype.loadTemplate = (templateId) -&gt;
            # Marionette expects &quot;templateId&quot; to be the ID of a DOM element.
            # But with RequireJS, templateId is actually the full text of the template.
            template = templateId

            # Make sure we have a template before trying to compile it
            if (!template || template.length == 0)
                msg = &quot;Could not find template: '&quot; + templateId + &quot;'&quot;
                err = new Error(msg)
                err.name = &quot;NoTemplateError&quot;
                throw err

            return template;

        BackboneMarionette.Renderer.render = (template, data) -&gt;
            return template(data)

        return
    )

    ###*
     * Overrides Backbone.wrapError to trigger an Application
     * server:error event whenenver an ajax call returns a
     * 401 status code.
     *
     * Allows us to centeralize the way the app responds to
     * session timeouts and un-authenticated user condition.
     *
     ###
    App.addInitializer((options) -&gt;
        App.onServerError = (originalModel, jqXHR, options) =&gt;
            if(jqXHR.status == 401)
                @user.session.set('active', false)
            return

        App.vent.bind(&quot;server:error&quot;, App.onServerError)
        Backbone.wrapError = (onError, originalModel, options) -&gt;
            return (model, resp) -&gt;
                if(model == originalModel)
                    resp = resp
                else
                    resp = model
                if (onError)
                    onError(originalModel, resp, options)
                    return
                else
                    originalModel.trigger('error', originalModel, resp, options)
                    App.vent.trigger('server:error', originalModel, resp, options)  # Only line added to original method
                    return
        return
    )    
    
    ###*
     * Sets up some application wide data formatting
     * utilities.
     * 
     * TODO: put these in their own class/module.
     ###
    App.addInitializer((options) -&gt;
        @formatters = {}

        @formatters.formatBytes = (size) -&gt;
            if (size &lt; 1024)
                return size + &quot;kb&quot;
            else if (size &lt; 1048576)
                return (Math.round(((size*10) / 1024) / 10)) + &quot;KB&quot;
            else
                return (Math.round(((size*10) / 1048576) / 10)) + &quot;MB&quot;

        @formatters.toTitleCase = (str) -&gt;
            return str.replace(/\w\S*/g, (txt) -&gt; return txt.charAt(0).toUpperCase() + txt.substr(1))
        
        return
    )    

    return App;
)
</pre>
</body>
</html>
